%%[0
%include lhs2TeX.fmt
%include afp.fmt
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Common AG for Core CLamCallInfo gathering & propagation
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Gathering CLamCallInfo
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[(8 codegen)
ATTR
  CModule CExpr
%%[[20
  CodeAGItf
%%]]
    [ | | gathCLamCallMp: CLamCallMp ]

SEM CExpr
  | Let         lhs         .   gathCLamCallMp =   @binds.bindCLamCallMp `Map.union` @body.gathCLamCallMp
  | * - Let Ann lhs         .   gathCLamCallMp =   Map.empty
%%]

%%[(8 codegen)
ATTR AllBind [ | | bindCLamCallMp USE {`Map.union`} {Map.empty}: CLamCallMp ]

%%]

%%[(8 codegen)
ATTR
  AllCodeNT
%%[[20
  CodeAGItf
%%]]
    [ clamCallMp: CLamCallMp | | ]
%%]

%%[(8 codegen).CodeAGItf.clamCallMp
SEM CodeAGItf
  | AGItf       module      .   clamCallMp  =   @module.gathCLamCallMp
%%]

%%[(20 codegen) -8.CodeAGItf.clamCallMp
SEM CodeAGItf
  | AGItf       loc         .   gathCLamCallMp
                                            =   clamCallMpUpdateWith @lhs.clamCallMp @module.gathCLamCallMp
                module      .   clamCallMp  =   @gathCLamCallMp `Map.union` @lhs.clamCallMp
%%]

%%[(8 codegen)
SEM CExpr
  | Lam         body        .   clamCallMp  =   Map.delete @arg @lhs.clamCallMp
%%]

